<script>
  import { getContext, onDestroy } from 'svelte'
  import CsvField from './components/CsvField.svelte'

  export let field
  export let label = ''
  export let dragZoneText = ''
  export let hideImportButton = false
  export let importButtonLabel = ''
  export let onChange

  const { styleable, Provider } = getContext('sdk')
  const component = getContext('component')
  const formContext = getContext('form')
  const formStepContext = getContext('form-step')

  console.log('ðŸ”¥ ~ component', component)
  console.log('ðŸ”¥ ~ skd', getContext('sdk'))

  let isParsed = false
  let ref = { isChanged: false }
  let fieldState
  let fieldApi

  const formApi = formContext?.formApi
  $: formStep = $formStepContext ?? 1
  $: formField = formApi?.registerField(
    field,
    'array',
    [],
    false,
    null,
    formStep
  )

  $: unsubscribe = formField?.subscribe(value => {
    fieldApi = value?.fieldApi
    fieldState = value?.fieldState
  })

  $: dataContext = {
    data: fieldState?.value || [],
  }
  console.log('ðŸ”¥ ~ dataContext', dataContext)

  // workaround, because onChange event cannot pass value yet.
  $: onValueChange(fieldState)

  const handleChange = e => {
    fieldApi.setValue(e.detail)
  }

  const onValueChange = fieldState => {
    console.log('ðŸ”¥ ~ data', fieldState?.value, ref.isChanged)
    // if (ref.isChanged) {
    onChange?.(fieldState)
    ref.isChanged = false
    // }
  }

  onDestroy(() => {
    fieldApi?.deregister()
    unsubscribe?.()
  })
</script>

<div use:styleable={$component.styles}>
  <Provider data={dataContext}>
    <CsvField
      {label}
      {dragZoneText}
      on:change={onChange}
      bind:isParsed
      {fieldState}
    />
    <slot />
  </Provider>
</div>
